<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Financeira - Fiozart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" type="imagex/png" href="https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#4a2c2a',
                        'brand-primary': '#8d5b4c',
                        'brand-light': '#d4a373',
                        'brand-bg': '#fdf8f0',
                        'brand-bg-light': '#fffaf3',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdf8f0;
            position: relative;
        }
        body::after {
            content: "";
            background-image: url('https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60vw;
            height: 60vh;
            opacity: 0.04;
            z-index: -1;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-brand-bg">

    <div class="container mx-auto max-w-5xl p-4 sm:p-8">
        
        <header class="text-center mb-8">
            <img src="https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0" alt="Logo Fiozart" class="h-24 w-auto mx-auto mb-4"/>
            <h1 class="text-4xl font-bold text-brand-dark">Gestão Fiozart</h1>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <!-- Coluna da Esquerda: Lançamentos e Histórico -->
            <div class="lg:col-span-2 space-y-8">
                <!-- Seção de Visão Geral -->
                <section class="bg-brand-bg-light p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b border-brand-light pb-2">
                         <h2 class="text-2xl font-semibold text-brand-dark">Resumo Financeiro</h2>
                         <input type="month" id="monthFilter" class="border-gray-300 rounded-md shadow-sm text-sm focus:ring-brand-primary focus:border-brand-primary">
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                        <div class="bg-green-50 p-6 rounded-xl border border-green-200">
                            <p class="text-sm font-medium text-green-700">Receitas do Mês</p>
                            <p id="totalReceitas" class="text-3xl font-bold text-green-600 mt-1">R$ 0,00</p>
                        </div>
                        <div class="bg-red-50 p-6 rounded-xl border border-red-200">
                            <p class="text-sm font-medium text-red-700">Despesas do Mês</p>
                            <p id="totalDespesas" class="text-3xl font-bold text-red-600 mt-1">R$ 0,00</p>
                        </div>
                        <div class="bg-blue-50 p-6 rounded-xl border border-blue-200">
                            <p class="text-sm font-medium text-blue-700">Lucro / Saldo</p>
                            <p id="saldoTotal" class="text-3xl font-bold text-blue-600 mt-1">R$ 0,00</p>
                        </div>
                    </div>
                </section>

                <!-- Seção para Adicionar Lançamento -->
                <section class="bg-brand-bg-light p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-4 border-b border-brand-light pb-2">
                        <h2 class="text-2xl font-semibold text-brand-dark">Adicionar Lançamento</h2>
                        <button id="manageCatalogBtn" class="text-sm text-brand-primary hover:text-brand-dark font-semibold">Gerenciar Catálogo</button>
                    </div>
                    <form id="transactionForm" class="space-y-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <label for="tipo" class="block text-sm font-medium text-gray-700">Tipo</label>
                                <select id="tipo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                                    <option value="receita">Receita</option>
                                    <option value="despesa">Despesa</option>
                                </select>
                            </div>
                            <div>
                                <label for="valor" class="block text-sm font-medium text-gray-700">Valor (R$)</label>
                                <input type="number" id="valor" step="0.01" placeholder="75,50" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary" required>
                            </div>
                            <div>
                                <label for="data" class="block text-sm font-medium text-gray-700">Data</label>
                                <input type="date" id="data" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary" required>
                            </div>
                            
                            <div id="campo-servico" class="sm:col-span-2">
                                 <label for="servico" class="block text-sm font-medium text-gray-700">Serviço Prestado</label>
                                 <select id="servico" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary"></select>
                            </div>

                             <div id="campo-categoria-despesa" class="sm:col-span-2 hidden">
                                <label for="categoria-despesa" class="block text-sm font-medium text-gray-700">Categoria da Despesa</label>
                                <select id="categoria-despesa" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                                    <option>Material de Trabalho</option>
                                    <option>Aluguel/Contas Fixas</option>
                                    <option>Marketing/Divulgação</option>
                                    <option>Transporte</option>
                                    <option>Alimentação</option>
                                    <option>Outros</option>
                                </select>
                             </div>
                            
                            <div id="campo-descricao" class="sm:col-span-1">
                                 <label for="descricao" class="block text-sm font-medium text-gray-700">Descrição</label>
                                 <input type="text" id="descricao" placeholder="Ex: Compra de jumbo" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-brand-primary focus:border-brand-primary">
                            </div>
                        </div>
                        <div class="pt-2">
                             <button type="submit" class="w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-light transition-colors">
                                Adicionar Lançamento
                            </button>
                        </div>
                    </form>
                </section>

                <!-- Análise Visual -->
                <section class="bg-brand-bg-light p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-brand-dark mb-4 border-b border-brand-light pb-2">Análise Visual do Mês</h2>
                    <div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold text-center text-brand-dark mb-2">Receitas vs. Despesas</h3>
                            <canvas id="fluxoCaixaChart"></canvas>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pt-4">
                             <div>
                                <h3 class="text-lg font-semibold text-center text-brand-dark mb-2">Composição das Despesas</h3>
                                <canvas id="despesasChart"></canvas>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-center text-brand-dark mb-2">Serviços Mais Rentáveis</h3>
                                <canvas id="servicosChart"></canvas>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Histórico de Lançamentos -->
                <section class="bg-brand-bg-light p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-brand-dark mb-4 border-b border-brand-light pb-2">Histórico de Lançamentos</h2>
                    <div id="transactionList" class="space-y-3">
                        <p id="empty-transactions" class="text-center text-gray-500 py-4">Nenhum lançamento adicionado ainda.</p>
                    </div>
                </section>
            </div>

            <!-- Coluna da Direita: Metas e Investimentos -->
            <div class="lg:col-span-1 space-y-8">
                <section class="bg-brand-bg-light p-6 rounded-2xl shadow-lg">
                    <h2 class="text-2xl font-semibold text-brand-dark mb-4 border-b border-brand-light pb-2">Metas e Investimentos</h2>
                    <form id="goalForm" class="space-y-4 mb-6">
                        <div>
                            <label for="goal-desc" class="block text-sm font-medium text-gray-700">Descrição da Meta</label>
                            <input type="text" id="goal-desc" placeholder="Ex: Cadeira de salão nova" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" required>
                        </div>
                        <div>
                            <label for="goal-total" class="block text-sm font-medium text-gray-700">Valor Total (R$)</label>
                            <input type="number" step="0.01" id="goal-total" placeholder="1500,00" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" required>
                        </div>
                        <button type="submit" class="w-full bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-dark transition-colors">Adicionar Meta</button>
                    </form>

                    <div id="goalList" class="space-y-4">
                         <p id="empty-goals" class="text-center text-gray-500 py-4">Nenhuma meta criada ainda.</p>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="text-center mt-8 text-gray-400 text-sm">
            <p>Desenvolvido para Fiozart</p>
        </footer>
    </div>
    
    <!-- Modal de Gerenciamento de Catálogo -->
    <div id="catalogModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-backdrop fixed inset-0" id="modalBackdrop"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-lg m-4 p-6 z-10">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-brand-dark">Gerenciar Catálogo de Serviços</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <!-- Formulário para adicionar/editar serviço -->
            <form id="serviceForm" class="mb-6 p-4 border rounded-lg bg-gray-50 space-y-3">
                <h3 id="serviceFormTitle" class="text-lg font-semibold text-brand-dark">Adicionar Novo Serviço</h3>
                <input type="hidden" id="serviceId">
                <div>
                    <label for="serviceName" class="block text-sm font-medium text-gray-700">Nome do Serviço</label>
                    <input type="text" id="serviceName" class="mt-1 block w-full border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label for="serviceValue" class="block text-sm font-medium text-gray-700">Valor Padrão (R$)</label>
                    <input type="number" step="0.01" id="serviceValue" class="mt-1 block w-full border-gray-300 rounded-md" required>
                </div>
                <div class="flex gap-2">
                    <button type="submit" id="saveServiceBtn" class="w-full bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-dark transition-colors">Salvar</button>
                    <button type="button" id="cancelEditBtn" class="w-full bg-gray-200 text-gray-700 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors hidden">Cancelar Edição</button>
                </div>
            </form>

            <!-- Lista de serviços -->
            <h3 class="text-lg font-semibold text-brand-dark mb-2">Serviços Cadastrados</h3>
            <div id="serviceList" class="space-y-2 max-h-64 overflow-y-auto pr-2">
                <!-- Serviços serão inseridos aqui -->
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENTOS DO DOM ---
    const transactionForm = document.getElementById('transactionForm');
    const totalReceitasEl = document.getElementById('totalReceitas');
    const totalDespesasEl = document.getElementById('totalDespesas');
    const saldoTotalEl = document.getElementById('saldoTotal');
    const transactionListEl = document.getElementById('transactionList');
    const dataInput = document.getElementById('data');
    const tipoSelect = document.getElementById('tipo');
    const valorInput = document.getElementById('valor');
    const servicoSelect = document.getElementById('servico');
    const categoriaDespesaSelect = document.getElementById('categoria-despesa');
    const descricaoInput = document.getElementById('descricao');
    const campoServico = document.getElementById('campo-servico');
    const campoCategoriaDespesa = document.getElementById('campo-categoria-despesa');
    const campoDescricao = document.getElementById('campo-descricao');
    const monthFilter = document.getElementById('monthFilter');
    const goalForm = document.getElementById('goalForm');
    const goalListEl = document.getElementById('goalList');
    const emptyGoalsEl = document.getElementById('empty-goals');
    
    // --- Elementos do Modal de Catálogo ---
    const catalogModal = document.getElementById('catalogModal');
    const manageCatalogBtn = document.getElementById('manageCatalogBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const serviceForm = document.getElementById('serviceForm');
    const serviceFormTitle = document.getElementById('serviceFormTitle');
    const serviceIdInput = document.getElementById('serviceId');
    const serviceNameInput = document.getElementById('serviceName');
    const serviceValueInput = document.getElementById('serviceValue');
    const saveServiceBtn = document.getElementById('saveServiceBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const serviceListEl = document.getElementById('serviceList');

    // --- GRÁFICOS ---
    const ctxFluxo = document.getElementById('fluxoCaixaChart').getContext('2d');
    const ctxDespesas = document.getElementById('despesasChart').getContext('2d');
    const ctxServicos = document.getElementById('servicosChart').getContext('2d');
    let fluxoChart, despesasChart, servicosChart;

    // --- FUNÇÕES DE ARMAZENAMENTO ---
    const saveTransactions = () => localStorage.setItem('fiozart_transactions', JSON.stringify(allTransactions));
    const saveGoals = () => localStorage.setItem('fiozart_goals', JSON.stringify(goals));
    const saveCatalogo = () => localStorage.setItem('fiozart_catalogo', JSON.stringify(catalogoServicos));
    const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // --- CARREGAMENTO DE DADOS DO LOCALSTORAGE ---
    let allTransactions = JSON.parse(localStorage.getItem('fiozart_transactions')) || [];
    let goals = JSON.parse(localStorage.getItem('fiozart_goals')) || [];
    let catalogoServicos = JSON.parse(localStorage.getItem('fiozart_catalogo'));

    // --- INICIALIZAÇÃO DO CATÁLOGO PADRÃO (SE FOR A PRIMEIRA VEZ) ---
    if (!catalogoServicos || catalogoServicos.length === 0) {
        catalogoServicos = [
            { id: Date.now() + 1, nome: 'Box Braids (Tradicional)', valor: 250.00 },
            { id: Date.now() + 2, nome: 'Nagô (Lateral)', valor: 80.00 },
            { id: Date.now() + 3, nome: 'Twist', valor: 220.00 },
            { id: Date.now() + 4, nome: 'Mão de Obra (cliente c/ material)', valor: 120.00 },
        ];
        saveCatalogo();
    }
    
    // --- LÓGICA DE GERENCIAMENTO DO CATÁLOGO ---
    const openCatalogModal = () => catalogModal.classList.remove('hidden');
    const closeCatalogModal = () => catalogModal.classList.add('hidden');

    const resetServiceForm = () => {
        serviceForm.reset();
        serviceIdInput.value = '';
        serviceFormTitle.textContent = 'Adicionar Novo Serviço';
        saveServiceBtn.textContent = 'Salvar';
        cancelEditBtn.classList.add('hidden');
    };
    
    const renderCatalogList = () => {
        serviceListEl.innerHTML = '';
        if (catalogoServicos.length === 0) {
            serviceListEl.innerHTML = `<p class="text-sm text-gray-500 text-center">Nenhum serviço cadastrado.</p>`;
            return;
        }
        catalogoServicos.forEach(service => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 border rounded-md';
            item.innerHTML = `
                <div>
                    <p class="font-semibold text-brand-dark">${service.nome}</p>
                    <p class="text-sm text-gray-600">${formatCurrency(service.valor)}</p>
                </div>
                <div class="flex gap-2">
                    <button onclick="editService(${service.id})" class="text-sm text-blue-600 hover:text-blue-800">Editar</button>
                    <button onclick="deleteService(${service.id})" class="text-sm text-red-600 hover:text-red-800">Excluir</button>
                </div>
            `;
            serviceListEl.appendChild(item);
        });
    };

    const handleSaveService = (e) => {
        e.preventDefault();
        const id = serviceIdInput.value ? Number(serviceIdInput.value) : null;
        const nome = serviceNameInput.value;
        const valor = parseFloat(serviceValueInput.value);

        if (!nome.trim() || isNaN(valor)) {
            alert('Por favor, preencha os campos corretamente.');
            return;
        }

        if (id) { // Editando
            const serviceIndex = catalogoServicos.findIndex(s => s.id === id);
            if (serviceIndex > -1) {
                catalogoServicos[serviceIndex] = { id, nome, valor };
            }
        } else { // Adicionando
            catalogoServicos.push({ id: Date.now(), nome, valor });
        }

        saveCatalogo();
        renderCatalogList();
        popularCatalogoNoForm();
        resetServiceForm();
    };

    window.editService = (id) => {
        const service = catalogoServicos.find(s => s.id === id);
        if (service) {
            serviceIdInput.value = service.id;
            serviceNameInput.value = service.nome;
            serviceValueInput.value = service.valor.toFixed(2);
            serviceFormTitle.textContent = 'Editar Serviço';
            saveServiceBtn.textContent = 'Salvar Alterações';
            cancelEditBtn.classList.remove('hidden');
            serviceNameInput.focus();
        }
    };
    
    window.deleteService = (id) => {
        if (confirm('Tem certeza que deseja excluir este serviço do catálogo?')) {
            catalogoServicos = catalogoServicos.filter(s => s.id !== id);
            saveCatalogo();
            renderCatalogList();
            popularCatalogoNoForm();
        }
    };
    
    const popularCatalogoNoForm = () => {
        servicoSelect.innerHTML = '<option value="" data-valor="0">-- Selecione um serviço --</option>';
        catalogoServicos.forEach(servico => {
            const option = document.createElement('option');
            option.value = servico.nome;
            option.dataset.valor = servico.valor;
            option.textContent = servico.nome;
            servicoSelect.appendChild(option);
        });
        const outroOption = document.createElement('option');
        outroOption.value = 'Outro (descrever manualmente)';
        outroOption.dataset.valor = 0;
        outroOption.textContent = 'Outro (descrever manualmente)';
        servicoSelect.appendChild(outroOption);
    };

    // --- RESTANTE DAS FUNÇÕES (Dashboard, Transações, Metas, Gráficos) ---
    const updateDashboard = () => {
        const selectedMonth = monthFilter.value;
        const transactions = allTransactions.filter(t => t.data.startsWith(selectedMonth));
        const receitas = transactions.filter(t => t.tipo === 'receita').reduce((acc, t) => acc + t.valor, 0);
        const despesas = transactions.filter(t => t.tipo === 'despesa').reduce((acc, t) => acc + t.valor, 0);
        const saldo = receitas - despesas;
        totalReceitasEl.textContent = formatCurrency(receitas);
        totalDespesasEl.textContent = formatCurrency(despesas);
        saldoTotalEl.textContent = formatCurrency(saldo);
        saldoTotalEl.classList.remove('text-green-600', 'text-red-600', 'text-blue-600');
        saldoTotalEl.classList.add(saldo >= 0 ? 'text-green-600' : 'text-red-600');
        renderTransactions(transactions);
        updateCharts(transactions);
    };

    const renderTransactions = (transactionsToRender) => {
        transactionListEl.innerHTML = "";
        if (transactionsToRender.length === 0) {
            transactionListEl.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum lançamento neste mês.</p>`;
            return;
        }
        [...transactionsToRender].sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(t => {
            const isExpense = t.tipo === 'despesa';
            const item = document.createElement("div");
            item.className = `flex items-center justify-between p-3 rounded-lg border ${isExpense ? "bg-red-50 border-red-200" : "bg-green-50 border-green-200"}`;
            item.innerHTML = `
                <div>
                    <p class="font-semibold text-brand-dark">${t.descricao}</p>
                    <p class="text-sm text-gray-500">${new Date(t.data + "T00:00:00-03:00").toLocaleDateString("pt-BR")}</p>
                </div>
                <div class="text-right">
                    <p class="font-bold ${isExpense ? "text-red-600" : "text-green-600"}">${isExpense ? "-" : "+"} ${formatCurrency(t.valor)}</p>
                    <button onclick="deleteTransaction(${t.id})" class="text-xs text-gray-400 hover:text-red-500 transition-colors mt-1">Excluir</button>
                </div>`;
            transactionListEl.appendChild(item);
        });
    };

    const addTransaction = (e) => {
        e.preventDefault();
        const tipo = tipoSelect.value;
        const valor = parseFloat(valorInput.value);
        const data = dataInput.value;
        let descricao;
        let categoria = null;
        if (tipo === 'receita') {
            const servicoSelecionado = servicoSelect.value;
            if (servicoSelecionado === 'Outro (descrever manualmente)') {
                descricao = descricaoInput.value;
            } else if (servicoSelecionado) {
                descricao = servicoSelecionado;
            } else {
                alert("Por favor, selecione um serviço.");
                return;
            }
        } else {
            categoria = categoriaDespesaSelect.value;
            descricao = descricaoInput.value || categoria;
        }
        if (!descricao.trim() || isNaN(valor) || valor <= 0) {
            alert("Por favor, preencha a descrição e o valor corretamente.");
            return;
        }
        allTransactions.push({ id: Date.now(), descricao, valor, tipo, data, categoria });
        saveTransactions();
        monthFilter.value = data.substring(0, 7);
        updateDashboard();
        transactionForm.reset();
        dataInput.valueAsDate = new Date();
        toggleTransactionFields();
    };

    window.deleteTransaction = (id) => {
        if (confirm("Deseja excluir este lançamento?")) {
            allTransactions = allTransactions.filter(t => t.id !== id);
            saveTransactions();
            updateDashboard();
        }
    };

    const toggleTransactionFields = () => {
        const isReceita = tipoSelect.value === 'receita';
        campoServico.classList.toggle('hidden', !isReceita);
        campoCategoriaDespesa.classList.toggle('hidden', isReceita);
        if (isReceita && servicoSelect.value !== 'Outro (descrever manualmente)') {
            campoDescricao.classList.add('hidden');
            descricaoInput.required = false;
        } else {
            campoDescricao.classList.remove('hidden');
            descricaoInput.required = true;
            descricaoInput.placeholder = isReceita ? 'Descrição da receita' : 'Ex: Compra de jumbo';
        }
    };

    const updateCharts = (transactions) => {
        const daysInMonth = new Date(monthFilter.value.split("-")[0], monthFilter.value.split("-")[1], 0).getDate();
        const labels = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        const receitasPorDia = new Array(daysInMonth).fill(0);
        const despesasPorDia = new Array(daysInMonth).fill(0);
        transactions.forEach(t => {
            const day = new Date(t.data + "T00:00:00-03:00").getDate() - 1;
            if (t.tipo === 'receita') receitasPorDia[day] += t.valor;
            else despesasPorDia[day] += t.valor;
        });
        if (fluxoChart) fluxoChart.destroy();
        fluxoChart = new Chart(ctxFluxo, { type: "line", data: { labels, datasets: [{ label: "Receitas", data: receitasPorDia, borderColor: "#16a34a", backgroundColor: "rgba(22, 163, 74, 0.1)", fill: true, tension: .3 }, { label: "Despesas", data: despesasPorDia, borderColor: "#dc2626", backgroundColor: "rgba(220, 38, 38, 0.1)", fill: true, tension: .3 }] } });
        const despesasData = transactions.filter(t => t.tipo === 'despesa').reduce((acc, t) => {
            acc[t.categoria] = (acc[t.categoria] || 0) + t.valor;
            return acc;
        }, {});
        if (despesasChart) despesasChart.destroy();
        despesasChart = new Chart(ctxDespesas, { type: "doughnut", data: { labels: Object.keys(despesasData), datasets: [{ data: Object.values(despesasData), backgroundColor: ["#8d5b4c", "#d4a373", "#4a2c2a", "#a16207", "#c2410c", "#facc15"] }] } });
        const servicosData = transactions.filter(t => t.tipo === 'receita').reduce((acc, t) => {
            acc[t.descricao] = (acc[t.descricao] || 0) + t.valor;
            return acc;
        }, {});
        if (servicosChart) servicosChart.destroy();
        servicosChart = new Chart(ctxServicos, { type: "bar", data: { labels: Object.keys(servicosData), datasets: [{ label: "Receita por Serviço", data: Object.values(servicosData), backgroundColor: "#8d5b4c", borderColor: "#4a2c2a", borderWidth: 1 }] }, options: { indexAxis: "y" } });
    };

    const renderGoals = () => {
        goalListEl.innerHTML = "";
        if (goals.length === 0) {
            goalListEl.innerHTML = `<p id="empty-goals" class="text-center text-gray-500 py-4">Nenhuma meta criada ainda.</p>`;
            return;
        }
        goals.forEach(t => {
            const e = t.total > 0 ? t.guardado / t.total * 100 : 0;
            const o = document.createElement("div");
            o.className = "p-4 border border-brand-light/50 rounded-lg space-y-3 bg-white";
            let n = t.compras.map((e, o) => `<li class="flex justify-between items-center text-sm text-gray-600"><span>- ${e}</span><button onclick="deleteShoppingItem(${t.id}, ${o})" class="text-red-400 hover:text-red-600">&times;</button></li>`).join("");
            o.innerHTML = `<div class="flex justify-between items-start"><h3 class="font-bold text-brand-dark">${t.descricao}</h3><button onclick="deleteGoal(${t.id})" class="text-gray-400 hover:text-red-500 font-bold">&times;</button></div><div><div class="flex justify-between text-sm font-medium text-gray-600 mb-1"><span>${formatCurrency(t.guardado)}</span><span>${formatCurrency(t.total)}</span></div><div class="w-full bg-gray-200 rounded-full h-4"><div class="bg-brand-primary h-4 rounded-full" style="width: ${e}%"></div></div></div><div class="flex gap-2"><input type="number" step="0.01" id="add-amount-${t.id}" class="w-full border-gray-300 rounded-md shadow-sm text-sm" placeholder="Adicionar valor"><button onclick="addAmountToGoal(${t.id})" class="bg-gray-200 text-gray-700 px-3 rounded-md hover:bg-gray-300 text-sm font-bold">+</button></div><div><h4 class="text-sm font-semibold text-gray-600 mt-2">Lista de Compras:</h4><ul class="list-none space-y-1 mt-1">${n||'<li class="text-xs text-gray-400">Nenhum item.</li>'}</ul><div class="flex gap-2 mt-2"><input type="text" id="add-shopping-${t.id}" class="w-full border-gray-300 rounded-md shadow-sm text-sm" placeholder="Item a comprar"><button onclick="addShoppingItem(${t.id})" class="bg-gray-200 text-gray-700 px-3 rounded-md hover:bg-gray-300 text-sm font-bold">+</button></div></div>`;
            goalListEl.appendChild(o);
        });
    };

    const addGoal = t => {
        t.preventDefault();
        const e = document.getElementById("goal-desc").value,
            o = parseFloat(document.getElementById("goal-total").value);
        if (e.trim() && !isNaN(o) && o > 0) {
            goals.push({ id: Date.now(), descricao: e, total: o, guardado: 0, compras: [] });
            saveGoals();
            renderGoals();
            goalForm.reset();
        }
    };

    window.deleteGoal = t => {
        if(confirm("Tem certeza?")){
            goals = goals.filter(e => e.id !== t);
            saveGoals();
            renderGoals();
        }
    };
    
    window.addAmountToGoal = t => {
        const e = document.getElementById(`add-amount-${t}`),
            o = parseFloat(e.value);
        if (!isNaN(o) && o > 0) {
            const n = goals.find(e => e.id === t);
            if(n){
                n.guardado += o;
                saveGoals();
                renderGoals();
                e.value = "";
            }
        }
    };

    window.addShoppingItem = t => {
        const e = document.getElementById(`add-shopping-${t}`),
            o = e.value.trim();
        if (o) {
            const n = goals.find(e => e.id === t);
            if(n){
                n.compras.push(o);
                saveGoals();
                renderGoals();
                e.value = "";
            }
        }
    };

    window.deleteShoppingItem = (t, e) => {
        const o = goals.find(o => o.id === t);
        if(o){
            o.compras.splice(e, 1);
            saveGoals();
            renderGoals();
        }
    };

    // --- INICIALIZAÇÃO & EVENTOS ---
    const init = () => {
        const today = new Date();
        monthFilter.value = today.toISOString().substring(0, 7);
        dataInput.valueAsDate = today;

        // Eventos principais
        tipoSelect.addEventListener('change', toggleTransactionFields);
        servicoSelect.addEventListener('change', (e) => {
            const selectedOption = e.target.options[e.target.selectedIndex];
            const valorServico = parseFloat(selectedOption.dataset.valor);
            valorInput.value = valorServico > 0 ? valorServico.toFixed(2) : '';
            toggleTransactionFields();
        });
        transactionForm.addEventListener('submit', addTransaction);
        goalForm.addEventListener('submit', addGoal);
        monthFilter.addEventListener('change', updateDashboard);
        
        // Eventos do Modal de Catálogo
        manageCatalogBtn.addEventListener('click', () => {
            renderCatalogList();
            openCatalogModal();
        });
        closeModalBtn.addEventListener('click', closeCatalogModal);
        modalBackdrop.addEventListener('click', closeCatalogModal);
        serviceForm.addEventListener('submit', handleSaveService);
        cancelEditBtn.addEventListener('click', resetServiceForm);

        // Inicialização dos dados
        popularCatalogoNoForm();
        toggleTransactionFields();
        updateDashboard();
        renderGoals();
    };

    init();
});
</script>
</body>
</html>

