<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Fiozart - Financeiro e Agenda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" type="imagex/png" href="https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0">
    <!-- CDN do FullCalendar -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script>
        // Customização de cores do Tailwind para a marca Fiozart
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-dark': '#4a2c2a',
                        'brand-primary': '#8d5b4c',
                        'brand-light': '#d4a373',
                        'brand-bg': '#fdf8f0',
                        'brand-bg-light': '#fffaf3',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fdf8f0;
            position: relative;
        }
        /* Estilo para a marca d'água */
        body::after {
            content: "";
            background-image: url('https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0');
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.03;
            z-index: -1;
            pointer-events: none;
        }
        /* Ajustes no FullCalendar para combinar com o tema */
        :root {
            --fc-border-color: #d4a373;
            --fc-daygrid-event-dot-width: 8px;
            --fc-today-bg-color: rgba(212, 163, 115, 0.1);
            --fc-button-bg-color: #8d5b4c;
            --fc-button-active-bg-color: #4a2c2a;
            --fc-button-hover-bg-color: #6b4438;
            --fc-button-border-color: #8d5b4c;
            --fc-button-active-border-color: #4a2c2a;
            --fc-button-hover-border-color: #6b4438;
        }
        .fc .fc-toolbar-title {
            color: #4a2c2a;
        }
        .fc .fc-daygrid-day-number {
             color: #8d5b4c;
        }
        .progress-bar {
            background-color: #e5e7eb;
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
        }
        .progress-bar-inner {
            background-color: #16a34a;
            height: 100%;
            transition: width 0.3s ease-in-out;
        }
        .client-list-item.active {
            background-color: #8d5b4c;
            color: white;
        }

        /* Estilos de Impressão */
        @media print {
            body * {
                visibility: hidden;
            }
            #report-content, #report-content * {
                visibility: visible;
            }
            #report-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            canvas {
                max-width: 100% !important;
                height: auto !important;
            }
        }
    </style>
</head>

<body class="bg-brand-bg text-brand-dark">

    <!-- Cabeçalho -->
    <header class="bg-brand-bg-light/80 backdrop-blur-sm sticky top-0 z-20 shadow-sm p-4 print:hidden">
        <div class="container mx-auto flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <img src="https://lh3.googleusercontent.com/pw/AP1GczNl9v7hV_OTYYB2EH-_MAv5NKlYbowCoalKvFaolRxC7wDO6TzrB2A9jrn3E74sK5mf9Vl8x7eO8pukFYGnpWEdidpTVtLHCLA-kEfhYb1FdsDTdFvZJa8cUP3KP5Wg2flK7KfwukGLyXycjbdXtOrwgA=w607-h607-s-no-gm?authuser=0" alt="Logo Fiozart" class="h-10 w-auto" id="logo-img">
                <h1 class="text-xl md:text-2xl font-bold text-brand-dark">Gestão Fiozart</h1>
            </div>

            <div class="flex items-center gap-2 flex-wrap">
                 <button id="toggleToFinanceiro" class="text-sm md:text-base bg-brand-primary text-white font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-brand-dark transition-all">
                    Financeiro
                </button>
                <button id="toggleToAgenda" class="text-sm md:text-base bg-brand-primary text-white font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-brand-dark transition-all">
                    Agenda
                </button>
                <button id="toggleToClientes" class="text-sm md:text-base bg-brand-primary text-white font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-brand-dark transition-all">
                    Clientes
                </button>
                 <button id="toggleToRelatorios" class="text-sm md:text-base bg-brand-primary text-white font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-brand-dark transition-all">
                    Relatórios
                </button>
                <button id="backupBtn" class="text-sm md:text-base bg-gray-200 text-gray-700 font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-gray-300 transition-all">
                    Backup
                </button>
                <button id="restoreBtn" class="text-sm md:text-base bg-gray-200 text-gray-700 font-semibold py-2 px-3 md:px-4 rounded-lg hover:bg-gray-300 transition-all">
                    Restaurar
                </button>
                <input type="file" id="restoreFile" class="hidden" accept=".json">
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <main class="container mx-auto p-4 md:p-6">
        
        <!-- VISÃO FINANCEIRA (INICIAL) -->
        <div id="financeiroView">
            <!-- Cards de Resumo -->
            <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold text-gray-500">Receita do Mês</h3>
                    <p id="receita-mes" class="text-3xl font-bold text-green-600 mt-2">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold text-gray-500">Despesa do Mês</h3>
                    <p id="despesa-mes" class="text-3xl font-bold text-red-600 mt-2">R$ 0,00</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md border-2 border-brand-primary">
                    <h3 class="text-lg font-semibold text-gray-500">Lucro do Mês</h3>
                    <p id="lucro-mes" class="text-3xl font-bold text-brand-dark mt-2">R$ 0,00</p>
                </div>
            </section>
            
            <!-- Seção Principal Dividida -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Coluna de Lançamentos -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4 border-b pb-3">
                             <h2 class="text-xl font-bold">Adicionar Lançamento</h2>
                             <button id="openCatalogBtn" class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded-md hover:bg-gray-300">Gerenciar Catálogo</button>
                        </div>
                        <form id="transaction-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium">Tipo</label>
                                <div class="mt-1 grid grid-cols-2 gap-2">
                                    <button type="button" id="btn-receita" class="w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Receita</button>
                                    <button type="button" id="btn-despesa" class="w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg">Despesa</button>
                                </div>
                            </div>
                            <!-- Campo de seleção de serviços (para receitas) -->
                            <div id="servico-container">
                                <label for="servico-select" class="block text-sm font-medium">Serviço Prestado</label>
                                <select id="servico-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary"></select>
                            </div>
                            <!-- Campo de descrição (para despesas e outras receitas) -->
                            <div id="descricao-container" class="hidden">
                                <label for="descricao" class="block text-sm font-medium">Descrição</label>
                                <input type="text" id="descricao" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary">
                            </div>

                             <!-- Campo de Categoria para Despesas -->
                            <div id="categoria-despesa-container" class="hidden">
                                <label for="categoria-despesa" class="block text-sm font-medium">Categoria da Despesa</label>
                                <select id="categoria-despesa" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary">
                                    <option>Material</option>
                                    <option>Aluguel/Contas</option>
                                    <option>Marketing</option>
                                    <option>Alimentação</option>
                                    <option>Transporte</option>
                                    <option>Outros</option>
                                </select>
                            </div>

                            <div>
                                <label for="valor" class="block text-sm font-medium">Valor (R$)</label>
                                <input type="text" inputmode="decimal" id="valor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" required>
                            </div>
                            <div>
                                <label for="data" class="block text-sm font-medium">Data</label>
                                <input type="date" id="data" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-brand-primary focus:border-brand-primary" required>
                            </div>
                            <button type="submit" class="w-full bg-brand-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-brand-dark transition-colors">Adicionar</button>
                        </form>
                    </div>
                </div>

                <!-- Coluna de Histórico e Gráficos -->
                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-3">Últimos Lançamentos</h2>
                        <div id="transaction-list" class="space-y-3 max-h-60 overflow-y-auto">
                            <!-- Lançamentos aqui -->
                        </div>
                    </div>

                    <!-- PAINEL DE METAS -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-3">Minhas Metas Financeiras</h2>
                        <form id="meta-form" class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
                            <input type="text" id="meta-nome" placeholder="Nome da Meta" class="sm:col-span-2 border-gray-300 rounded-md shadow-sm" required>
                            <input type="text" inputmode="decimal" id="meta-valor-total" placeholder="Valor Total (R$)" class="border-gray-300 rounded-md shadow-sm" required>
                            <button type="submit" class="sm:col-span-3 w-full bg-brand-light text-brand-dark font-bold py-2 px-4 rounded-lg hover:bg-opacity-80 transition-colors">Adicionar Meta</button>
                        </form>
                        <div id="meta-list" class="space-y-4 max-h-60 overflow-y-auto">
                            <!-- Metas aqui -->
                        </div>
                    </div>

                     <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4 border-b pb-3">Análise Visual</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                               <h3 class="text-center font-semibold text-gray-600 mb-2">Receitas x Despesas (dia a dia)</h3>
                               <canvas id="fluxoCaixaChart"></canvas>
                            </div>
                            <div>
                               <h3 class="text-center font-semibold text-gray-600 mb-2">Composição das Despesas</h3>
                               <canvas id="despesasChart"></canvas>
                            </div>
                        </div>
                     </div>
                </div>
            </div>
        </div>

        <!-- VISÃO DA AGENDA (OCULTA) -->
        <div id="agendaView" class="hidden">
            <section class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                <div id='calendario'></div>
            </section>
        </div>
        
        <!-- VISÃO DE CLIENTES (OCULTA) -->
        <div id="clientesView" class="hidden">
            <section class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Coluna da Lista de Clientes -->
                <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                         <h2 class="text-xl font-bold">Seus Clientes</h2>
                         <button id="addClienteBtn" class="bg-brand-primary text-white font-bold py-2 px-3 rounded-lg hover:bg-brand-dark text-sm">Novo +</button>
                    </div>
                    <div id="client-list" class="space-y-2 max-h-[600px] overflow-y-auto">
                        <!-- Lista de clientes será populada aqui -->
                    </div>
                </div>
                <!-- Coluna de Detalhes do Cliente -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                     <div id="client-details-content">
                         <div id="client-details-placeholder" class="text-center text-gray-500 pt-10">
                            <p>Selecione um cliente na lista para ver seus detalhes e histórico de agendamentos.</p>
                        </div>
                        <div id="client-details-view" class="hidden">
                             <div class="flex flex-col sm:flex-row justify-between items-start mb-4 border-b pb-3 gap-4">
                                 <div>
                                     <h2 id="client-detail-name" class="text-2xl font-bold text-brand-dark">Nome do Cliente</h2>
                                     <p id="client-detail-contact" class="text-gray-600">Contato</p>
                                     <p id="client-detail-instagram" class="text-gray-600 text-sm">Instagram</p>
                                 </div>
                                 <button id="editClienteBtn" class="bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 w-full sm:w-auto">Editar</button>
                             </div>
                             <div>
                                 <h3 class="font-semibold text-lg mb-2">Anotações</h3>
                                 <p id="client-detail-notes" class="bg-yellow-50 text-yellow-800 p-3 rounded-lg text-sm whitespace-pre-wrap min-h-[50px]">Nenhuma anotação.</p>
                             </div>
                             <div class="mt-6">
                                <h3 class="font-semibold text-lg mb-2">Histórico de Agendamentos</h3>
                                <div id="client-detail-history" class="space-y-3 max-h-80 overflow-y-auto">
                                    <!-- Histórico será populado aqui -->
                                </div>
                             </div>
                        </div>
                     </div>
                </div>
            </section>
        </div>

        <!-- VISÃO DE RELATÓRIOS (OCULTA) -->
        <div id="relatoriosView" class="hidden">
            <!-- Filtros -->
            <section class="bg-white p-4 rounded-xl shadow-md mb-6 print:hidden">
                <div class="flex flex-wrap items-center gap-4">
                    <div>
                        <label for="report-start-date" class="block text-sm font-medium">Data de Início</label>
                        <input type="date" id="report-start-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="report-end-date" class="block text-sm font-medium">Data de Fim</label>
                        <input type="date" id="report-end-date" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="self-end">
                        <button id="generateReportBtn" class="w-full sm:w-auto bg-brand-primary text-white font-bold py-2 px-5 rounded-lg hover:bg-brand-dark">Gerar Relatório</button>
                    </div>
                    <div class="self-end">
                         <button id="printReportBtn" class="w-full sm:w-auto bg-gray-200 text-gray-700 font-semibold py-2 px-5 rounded-lg hover:bg-gray-300">Imprimir</button>
                    </div>
                </div>
            </section>

            <!-- Conteúdo do Relatório -->
            <div id="report-content" class="space-y-6">
                <h1 class="text-3xl font-bold text-brand-dark text-center mb-4">Relatório de Desempenho</h1>
                <p id="report-period" class="text-center text-gray-500 -mt-4 mb-6">Período: --/--/---- a --/--/----</p>
                
                <!-- KPIs do Relatório -->
                <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Total Faturado</h3>
                        <p id="report-total-receita" class="text-3xl font-bold text-green-600 mt-2">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Total Despesas</h3>
                        <p id="report-total-despesa" class="text-3xl font-bold text-red-600 mt-2">R$ 0,00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h3 class="text-lg font-semibold text-gray-500">Lucro Total</h3>
                        <p id="report-total-lucro" class="text-3xl font-bold text-brand-dark mt-2">R$ 0,00</p>
                    </div>
                </section>
                
                <!-- Gráfico Anual -->
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Faturamento Mensal</h2>
                    <canvas id="reportFaturamentoChart"></canvas>
                </section>
                
                <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Ranking de Serviços -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Ranking de Serviços</h2>
                        <div id="report-servicos-list" class="space-y-3"></div>
                    </div>
                    <!-- Ranking de Clientes -->
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 class="text-xl font-bold mb-4">Ranking de Clientes</h2>
                        <div id="report-clientes-list" class="space-y-3"></div>
                    </div>
                </section>

                 <!-- Análise de Despesas -->
                <section class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4">Análise de Despesas por Categoria</h2>
                    <div class="max-w-md mx-auto">
                        <canvas id="reportDespesasChart"></canvas>
                    </div>
                </section>
            </div>
        </div>


        <footer class="text-center mt-8 text-gray-400 text-sm print:hidden">
            <p>Desenvolvido para Fiozart pelo Momo</p>
        </footer>

    </main>

    <!-- Modal de Gerenciamento do Catálogo -->
    <div id="catalogModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-30">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold">Gerenciar Catálogo de Serviços</h2>
                <button id="closeCatalogBtn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="catalog-form" class="flex gap-2 mb-4">
                <input type="text" id="servico-nome" placeholder="Nome do serviço" class="flex-grow border-gray-300 rounded-md shadow-sm" required>
                <input type="text" inputmode="decimal" id="servico-valor" placeholder="Valor (R$)" class="w-32 border-gray-300 rounded-md shadow-sm" required>
                <button type="submit" class="bg-brand-primary text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-dark">+</button>
            </form>
            <div id="catalog-list" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Lista de serviços do catálogo -->
            </div>
        </div>
    </div>
    
    <!-- Modal de Agendamento -->
    <div id="agendamentoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold" id="agendamentoModalTitle">Novo Agendamento</h2>
                <button id="closeAgendamentoBtn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="agendamento-form" class="space-y-4">
                <input type="hidden" id="agendamentoId">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="sm:col-span-1">
                        <label for="agendamento-data" class="block text-sm font-medium">Data</label>
                        <input type="date" id="agendamento-data" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div class="sm:col-span-1">
                        <label for="agendamento-hora-inicio" class="block text-sm font-medium">Início</label>
                        <input type="time" id="agendamento-hora-inicio" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div class="sm:col-span-1">
                        <label for="agendamento-hora-fim" class="block text-sm font-medium">Fim</label>
                        <input type="time" id="agendamento-hora-fim" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                <div>
                    <label for="agendamento-cliente-select" class="block text-sm font-medium">Cliente</label>
                     <select id="agendamento-cliente-select" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required></select>
                </div>
                <div>
                    <label for="agendamento-servico" class="block text-sm font-medium">Serviço Prestado</label>
                    <select id="agendamento-servico" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="agendamento-valor" class="block text-sm font-medium">Valor Cobrado (R$)</label>
                        <input type="text" inputmode="decimal" id="agendamento-valor" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                    </div>
                    <div>
                        <label for="agendamento-status" class="block text-sm font-medium">Status</label>
                        <select id="agendamento-status" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                            <option value="Agendado">Agendado</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Realizado">Realizado</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>
                <div id="modal-actions" class="flex flex-wrap-reverse gap-3 pt-4">
                    <button type="submit" id="saveAgendamentoBtn" class="w-full sm:w-auto bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-brand-dark transition-colors">Salvar</button>
                    <button type="button" id="deleteAgendamentoBtn" class="w-full sm:w-auto bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors hidden">Excluir</button>
                    <button type="button" id="lancarReceitaBtn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors hidden">Lançar como Receita</button>
                    <button type="button" id="lembreteWppBtn" class="w-full sm:w-auto bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors hidden">Lembrete via WhatsApp</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Adicionar/Editar Cliente -->
    <div id="clienteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h2 class="text-xl font-bold" id="clienteModalTitle">Adicionar Novo Cliente</h2>
                <button id="closeClienteModalBtn" class="text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <form id="cliente-form" class="space-y-4">
                <input type="hidden" id="clienteId">
                <div>
                    <label for="cliente-nome" class="block text-sm font-medium">Nome Completo</label>
                    <input type="text" id="cliente-nome" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" required>
                </div>
                <div>
                    <label for="cliente-contato" class="block text-sm font-medium">Telefone / WhatsApp</label>
                    <input type="text" id="cliente-contato" placeholder="5586999991234" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cliente-instagram" class="block text-sm font-medium">Instagram (opcional)</label>
                    <input type="text" id="cliente-instagram" placeholder="sem @" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="cliente-notas" class="block text-sm font-medium">Anotações Importantes</label>
                    <textarea id="cliente-notas" rows="3" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <div class="flex flex-col sm:flex-row-reverse gap-3 pt-4">
                    <button type="submit" class="w-full sm:w-auto bg-brand-primary text-white font-bold py-2 px-6 rounded-lg hover:bg-brand-dark">Salvar Cliente</button>
                    <button type="button" id="deleteClienteBtn" class="w-full sm:w-auto bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 hidden">Excluir Cliente</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- CDN Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DO DOM ---
            const transactionForm = document.getElementById('transaction-form');
            const valorInput = document.getElementById('valor');
            const dataInput = document.getElementById('data');
            const transactionList = document.getElementById('transaction-list');
            const receitaMesEl = document.getElementById('receita-mes');
            const despesaMesEl = document.getElementById('despesa-mes');
            const lucroMesEl = document.getElementById('lucro-mes');
            const btnReceita = document.getElementById('btn-receita');
            const btnDespesa = document.getElementById('btn-despesa');
            const servicoContainer = document.getElementById('servico-container');
            const servicoSelect = document.getElementById('servico-select');
            const descricaoContainer = document.getElementById('descricao-container');
            const descricaoInput = document.getElementById('descricao');
            const categoriaDespesaContainer = document.getElementById('categoria-despesa-container');
            const categoriaDespesaSelect = document.getElementById('categoria-despesa');

            // Catálogo
            const openCatalogBtn = document.getElementById('openCatalogBtn');
            const closeCatalogBtn = document.getElementById('closeCatalogBtn');
            const catalogModal = document.getElementById('catalogModal');
            const catalogForm = document.getElementById('catalog-form');
            const servicoNomeInput = document.getElementById('servico-nome');
            const servicoValorInput = document.getElementById('servico-valor');
            const catalogList = document.getElementById('catalog-list');
            
            // Metas
            const metaForm = document.getElementById('meta-form');
            const metaNomeInput = document.getElementById('meta-nome');
            const metaValorTotalInput = document.getElementById('meta-valor-total');
            const metaList = document.getElementById('meta-list');

            // Navegação entre Views
            const toggleToFinanceiroBtn = document.getElementById('toggleToFinanceiro');
            const toggleToAgendaBtn = document.getElementById('toggleToAgenda');
            const toggleToClientesBtn = document.getElementById('toggleToClientes');
            const toggleToRelatoriosBtn = document.getElementById('toggleToRelatorios');
            const financeiroView = document.getElementById('financeiroView');
            const agendaView = document.getElementById('agendaView');
            const clientesView = document.getElementById('clientesView');
            const relatoriosView = document.getElementById('relatoriosView');

            // Agendamento
            const calendarioEl = document.getElementById('calendario');
            const agendamentoModal = document.getElementById('agendamentoModal');
            const closeAgendamentoBtn = document.getElementById('closeAgendamentoBtn');
            const agendamentoForm = document.getElementById('agendamento-form');
            const agendamentoModalTitle = document.getElementById('agendamentoModalTitle');
            const agendamentoIdInput = document.getElementById('agendamentoId');
            const agendamentoDataInput = document.getElementById('agendamento-data');
            const agendamentoHoraInicioInput = document.getElementById('agendamento-hora-inicio');
            const agendamentoHoraFimInput = document.getElementById('agendamento-hora-fim');
            const agendamentoClienteSelect = document.getElementById('agendamento-cliente-select');
            const agendamentoServicoSelect = document.getElementById('agendamento-servico');
            const agendamentoValorInput = document.getElementById('agendamento-valor');
            const agendamentoStatusSelect = document.getElementById('agendamento-status');
            const deleteAgendamentoBtn = document.getElementById('deleteAgendamentoBtn');
            const lancarReceitaBtn = document.getElementById('lancarReceitaBtn');
            const lembreteWppBtn = document.getElementById('lembreteWppBtn');

            // Clientes (CRM)
            const addClienteBtn = document.getElementById('addClienteBtn');
            const clientListEl = document.getElementById('client-list');
            const clientDetailsPlaceholder = document.getElementById('client-details-placeholder');
            const clientDetailsView = document.getElementById('client-details-view');
            const clientDetailName = document.getElementById('client-detail-name');
            const clientDetailContact = document.getElementById('client-detail-contact');
            const clientDetailInstagram = document.getElementById('client-detail-instagram');
            const clientDetailNotes = document.getElementById('client-detail-notes');
            const clientDetailHistory = document.getElementById('client-detail-history');
            const editClienteBtn = document.getElementById('editClienteBtn');
            const clienteModal = document.getElementById('clienteModal');
            const closeClienteModalBtn = document.getElementById('closeClienteModalBtn');
            const clienteModalTitle = document.getElementById('clienteModalTitle');
            const clienteForm = document.getElementById('cliente-form');
            const clienteIdInput = document.getElementById('clienteId');
            const clienteNomeInput = document.getElementById('cliente-nome');
            const clienteContatoInput = document.getElementById('cliente-contato');
            const clienteInstagramInput = document.getElementById('cliente-instagram');
            const clienteNotasInput = document.getElementById('cliente-notas');
            const deleteClienteBtn = document.getElementById('deleteClienteBtn');

            // Relatórios
            const reportStartDateInput = document.getElementById('report-start-date');
            const reportEndDateInput = document.getElementById('report-end-date');
            const generateReportBtn = document.getElementById('generateReportBtn');
            const printReportBtn = document.getElementById('printReportBtn');
            const reportPeriodEl = document.getElementById('report-period');
            const reportTotalReceitaEl = document.getElementById('report-total-receita');
            const reportTotalDespesaEl = document.getElementById('report-total-despesa');
            const reportTotalLucroEl = document.getElementById('report-total-lucro');
            const reportServicosListEl = document.getElementById('report-servicos-list');
            const reportClientesListEl = document.getElementById('report-clientes-list');

            // Backup e Restore
            const backupBtn = document.getElementById('backupBtn');
            const restoreBtn = document.getElementById('restoreBtn');
            const restoreFileInput = document.getElementById('restoreFile');


            // --- ESTADO DA APLICAÇÃO ---
            let transactions = JSON.parse(localStorage.getItem('fiozart_transactions')) || [];
            let catalogoServicos = JSON.parse(localStorage.getItem('fiozart_catalogo')) || [];
            let agendamentos = JSON.parse(localStorage.getItem('fiozart_agendamentos')) || [];
            let metas = JSON.parse(localStorage.getItem('fiozart_metas')) || [];
            let clientes = JSON.parse(localStorage.getItem('fiozart_clientes')) || [];
            let transactionType = 'receita';
            let selectedClientId = null;
            let fluxoCaixaChart, despesasChart, calendar, reportFaturamentoChart, reportDespesasChart;

            // --- FUNÇÕES UTILITÁRIAS ---
            const formatCurrency = (value) => parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const parseValue = (value) => parseFloat(String(value).replace(',', '.')) || 0;
            const formatDate = (dateString) => new Date(dateString + 'T00:00:00-03:00').toLocaleDateString('pt-BR');

            // --- FUNÇÕES DE ARMAZENAMENTO ---
            const saveTransactions = () => localStorage.setItem('fiozart_transactions', JSON.stringify(transactions));
            const saveCatalogo = () => localStorage.setItem('fiozart_catalogo', JSON.stringify(catalogoServicos));
            const saveAgendamentos = () => localStorage.setItem('fiozart_agendamentos', JSON.stringify(agendamentos));
            const saveMetas = () => localStorage.setItem('fiozart_metas', JSON.stringify(metas));
            const saveClientes = () => localStorage.setItem('fiozart_clientes', JSON.stringify(clientes));
            
            // --- LÓGICA DE NAVEGAÇÃO ---
            const switchView = (viewToShow) => {
                [financeiroView, agendaView, clientesView, relatoriosView].forEach(view => view.classList.add('hidden'));
                viewToShow.classList.remove('hidden');

                if(viewToShow === agendaView) renderCalendario();
                if(viewToShow === clientesView) {
                    renderClientList();
                    renderClientDetails(selectedClientId);
                }
                if(viewToShow === financeiroView) updateUI();
                if(viewToShow === relatoriosView) {
                     const today = new Date();
                     const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                     reportStartDateInput.value = firstDayOfMonth;
                     reportEndDateInput.value = today.toISOString().split('T')[0];
                     generateReport();
                }
            };

            // --- LÓGICA DE CATÁLOGO ---
            const popularCatalogoNoForm = (selectElement) => {
                selectElement.innerHTML = '<option value="">Selecione um serviço</option>';
                catalogoServicos.forEach(servico => {
                    const option = document.createElement('option');
                    option.value = servico.nome;
                    option.textContent = `${servico.nome} - ${formatCurrency(servico.valor)}`;
                    option.dataset.valor = servico.valor;
                    selectElement.appendChild(option);
                });
                if (transactionType === 'receita' && selectElement.id === 'servico-select') {
                    const optionOutro = document.createElement('option');
                    optionOutro.value = 'outro';
                    optionOutro.textContent = 'Outro (descrever manualmente)';
                    selectElement.appendChild(optionOutro);
                }
            };
            
            const renderCatalogoList = () => {
                catalogList.innerHTML = '';
                if (catalogoServicos.length === 0) {
                    catalogList.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum serviço cadastrado.</p>';
                    return;
                }
                catalogoServicos.forEach(servico => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center p-2 border rounded-md';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold">${servico.nome}</p>
                            <p class="text-sm text-gray-600">${formatCurrency(servico.valor)}</p>
                        </div>
                        <div>
                            <button data-id="${servico.id}" class="edit-servico-btn text-blue-500 mr-2">Editar</button>
                            <button data-id="${servico.id}" class="delete-servico-btn text-red-500">Excluir</button>
                        </div>
                    `;
                    catalogList.appendChild(div);
                });
            };
            
            // --- LÓGICA FINANCEIRA ---
            const addTransaction = (e) => {
                if(e) e.preventDefault();

                const valor = parseValue(valorInput.value);
                const data = dataInput.value;
                let descricao;
                let categoria = null;

                if (transactionType === 'receita') {
                    if (servicoSelect.value === 'outro') {
                        descricao = descricaoInput.value.trim();
                    } else {
                        descricao = servicoSelect.value;
                    }
                } else {
                    descricao = descricaoInput.value.trim();
                    categoria = categoriaDespesaSelect.value;
                }

                if (!descricao || !valor || !data) {
                    alert('Por favor, preencha todos os campos.');
                    return;
                }

                transactions.push({
                    id: Date.now(),
                    type: transactionType,
                    description: descricao,
                    amount: transactionType === 'receita' ? valor : -valor,
                    date: data,
                    category: categoria,
                });

                saveTransactions();
                updateUI();
                transactionForm.reset();
                dataInput.value = new Date().toISOString().split('T')[0];
                setTransactionType('receita');
            };
            
            const deleteTransaction = (id) => {
                transactions = transactions.filter(t => t.id !== id);
                saveTransactions();
                updateUI();
            };

            // --- LÓGICA DE METAS ---
            const renderMetas = () => {
                metaList.innerHTML = '';
                 if (metas.length === 0) {
                    metaList.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhuma meta cadastrada.</p>';
                    return;
                }
                metas.forEach(meta => {
                    const progresso = (meta.valorGuardado / meta.valorTotal) * 100;
                    const div = document.createElement('div');
                    div.className = 'border p-3 rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                           <div>
                                <p class="font-bold">${meta.nome}</p>
                                <p class="text-sm text-gray-600">${formatCurrency(meta.valorGuardado)} / ${formatCurrency(meta.valorTotal)}</p>
                           </div>
                            <span class="text-sm font-semibold">${progresso.toFixed(1)}%</span>
                        </div>
                        <div class="progress-bar mt-2">
                            <div class="progress-bar-inner" style="width: ${progresso}%;"></div>
                        </div>
                        <div class="text-right mt-2">
                             <button data-id="${meta.id}" class="add-valor-btn text-xs bg-green-100 text-green-700 px-2 py-1 rounded-md hover:bg-green-200">Adicionar Valor</button>
                             <button data-id="${meta.id}" class="delete-meta-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded-md hover:bg-red-200">Excluir</button>
                        </div>
                    `;
                    metaList.appendChild(div);
                });
            };
            
            // --- LÓGICA DE CLIENTES (CRM) ---
            const renderClientList = () => {
                clientListEl.innerHTML = '';
                 if (clientes.length === 0) {
                    clientListEl.innerHTML = '<p class="text-center text-gray-500 text-sm">Nenhum cliente cadastrado.</p>';
                    return;
                }
                clientes.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(cliente => {
                    const div = document.createElement('div');
                    div.className = 'client-list-item p-3 rounded-lg cursor-pointer hover:bg-brand-light/20';
                    if(cliente.id === selectedClientId) div.classList.add('active');
                    div.dataset.id = cliente.id;
                    div.innerHTML = `
                        <p class="font-semibold">${cliente.nome}</p>
                        <p class="text-sm">${cliente.contato}</p>
                    `;
                    div.addEventListener('click', () => {
                        selectedClientId = cliente.id;
                        renderClientDetails(cliente.id);
                        renderClientList(); // Re-render para atualizar a classe 'active'
                    });
                    clientListEl.appendChild(div);
                });
            };

            const renderClientDetails = (clientId) => {
                const cliente = clientes.find(c => c.id === clientId);
                if(!cliente) {
                    clientDetailsPlaceholder.classList.remove('hidden');
                    clientDetailsView.classList.add('hidden');
                    return;
                }
                
                clientDetailsPlaceholder.classList.add('hidden');
                clientDetailsView.classList.remove('hidden');

                clientDetailName.textContent = cliente.nome;
                clientDetailContact.textContent = cliente.contato || 'Nenhum contato salvo';
                clientDetailInstagram.textContent = cliente.instagram ? `@${cliente.instagram}` : 'Nenhum Instagram salvo';
                clientDetailNotes.textContent = cliente.notas || 'Nenhuma anotação.';
                editClienteBtn.dataset.id = cliente.id;

                // Histórico
                const historico = agendamentos.filter(ag => ag.clienteId === clientId).sort((a,b) => new Date(b.data) - new Date(a.data));
                clientDetailHistory.innerHTML = '';
                if(historico.length === 0) {
                    clientDetailHistory.innerHTML = '<p class="text-sm text-gray-500">Nenhum agendamento encontrado para este cliente.</p>';
                    return;
                }
                historico.forEach(ag => {
                     const div = document.createElement('div');
                     div.className = 'p-3 border-l-4 rounded-r-lg';
                     let borderColor = 'border-gray-400';
                     if (ag.status === 'Realizado') borderColor = 'border-green-500';
                     if (ag.status === 'Cancelado') borderColor = 'border-red-500';
                     if (ag.status === 'Confirmado') borderColor = 'border-blue-500';
                     div.classList.add(borderColor);

                     div.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-semibold">${ag.servicoNome}</p>
                            <p class="text-sm font-bold">${ag.status}</p>
                        </div>
                        <p class="text-sm text-gray-600">${formatDate(ag.data)} às ${ag.horaInicio}</p>
                        <p class="text-sm text-gray-600">${formatCurrency(ag.valorCobrado)}</p>
                     `;
                     clientDetailHistory.appendChild(div);
                });
            };

            const openClienteModal = (clienteId = null) => {
                clienteForm.reset();
                deleteClienteBtn.classList.add('hidden');
                if(clienteId) {
                    const cliente = clientes.find(c => c.id === clienteId);
                    clienteModalTitle.textContent = "Editar Cliente";
                    clienteIdInput.value = cliente.id;
                    clienteNomeInput.value = cliente.nome;
                    clienteContatoInput.value = cliente.contato;
                    clienteInstagramInput.value = cliente.instagram;
                    clienteNotasInput.value = cliente.notas;
                    deleteClienteBtn.classList.remove('hidden');
                } else {
                    clienteModalTitle.textContent = "Adicionar Novo Cliente";
                    clienteIdInput.value = '';
                }
                clienteModal.classList.remove('hidden');
            };

            const popularClientesNoAgendamento = () => {
                agendamentoClienteSelect.innerHTML = '<option value="">Selecione um cliente...</option>';
                 clientes.sort((a,b) => a.nome.localeCompare(b.nome)).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.nome;
                    agendamentoClienteSelect.appendChild(option);
                });
            };

            // --- LÓGICA DE AGENDAMENTO ---
            const renderCalendario = () => {
                const eventos = agendamentos.map(ag => {
                    const cliente = clientes.find(c => c.id === ag.clienteId);
                    const clienteNome = cliente ? cliente.nome : "Cliente Apagado";
                    let color = '#8d5b4c'; // Padrão 'Agendado'
                    if (ag.status === 'Confirmado') color = '#2563eb'; // Azul
                    if (ag.status === 'Realizado') color = '#16a34a'; // Verde
                    if (ag.status === 'Cancelado') color = '#dc2626'; // Vermelho

                    return {
                        id: ag.id,
                        title: `${clienteNome} - ${ag.servicoNome}`,
                        start: `${ag.data}T${ag.horaInicio}`,
                        end: `${ag.data}T${ag.horaFim}`,
                        backgroundColor: color,
                        borderColor: color,
                        extendedProps: { ...ag }
                    };
                });

                if(calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(eventos);
                } else {
                     calendar = new FullCalendar.Calendar(calendarioEl, {
                        locale: 'pt-br',
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        buttonText: {
                            today:    'Hoje',
                            month:    'Mês',
                            week:     'Semana',
                            day:      'Dia',
                            list:     'Lista'
                        },
                        events: eventos,
                        dateClick: (info) => {
                            agendamentoForm.reset();
                            agendamentoModalTitle.textContent = "Novo Agendamento";
                            agendamentoIdInput.value = '';
                            agendamentoDataInput.value = info.dateStr;
                            popularClientesNoAgendamento();
                            deleteAgendamentoBtn.classList.add('hidden');
                            lancarReceitaBtn.classList.add('hidden');
                            lembreteWppBtn.classList.add('hidden');
                            agendamentoModal.classList.remove('hidden');
                        },
                        eventClick: (info) => {
                            const ag = info.event.extendedProps;
                            agendamentoForm.reset();
                            agendamentoModalTitle.textContent = "Editar Agendamento";
                            agendamentoIdInput.value = ag.id;
                            agendamentoDataInput.value = ag.data;
                            agendamentoHoraInicioInput.value = ag.horaInicio;
                            agendamentoHoraFimInput.value = ag.horaFim;
                            popularClientesNoAgendamento();
                            agendamentoClienteSelect.value = ag.clienteId;
                            agendamentoServicoSelect.value = ag.servicoNome;
                            agendamentoValorInput.value = ag.valorCobrado;
                            agendamentoStatusSelect.value = ag.status;
                            
                            deleteAgendamentoBtn.classList.remove('hidden');
                            lembreteWppBtn.classList.remove('hidden');
                            
                            if(ag.status === 'Realizado' && !ag.receitaLancada) {
                                lancarReceitaBtn.classList.remove('hidden');
                                lancarReceitaBtn.disabled = false;
                                lancarReceitaBtn.textContent = 'Lançar como Receita';
                            } else if (ag.receitaLancada) {
                                 lancarReceitaBtn.classList.remove('hidden');
                                 lancarReceitaBtn.disabled = true;
                                 lancarReceitaBtn.textContent = 'Receita Lançada';
                            } else {
                                lancarReceitaBtn.classList.add('hidden');
                            }
                            
                            agendamentoModal.classList.remove('hidden');
                        }
                    });
                    calendar.render();
                }
            };
            
            const handleSaveAgendamento = (e) => {
                e.preventDefault();
                const id = parseInt(agendamentoIdInput.value);
                
                const agendamento = {
                    id: id || Date.now(),
                    data: agendamentoDataInput.value,
                    horaInicio: agendamentoHoraInicioInput.value,
                    horaFim: agendamentoHoraFimInput.value,
                    clienteId: parseInt(agendamentoClienteSelect.value),
                    servicoNome: agendamentoServicoSelect.value,
                    valorCobrado: parseValue(agendamentoValorInput.value),
                    status: agendamentoStatusSelect.value,
                };
                
                if (!agendamento.data || !agendamento.horaInicio || !agendamento.horaFim || !agendamento.clienteId || !agendamento.servicoNome || !agendamento.valorCobrado) {
                     alert('Por favor, preencha os campos obrigatórios.');
                     return;
                }

                if (id) { // Editando
                    const index = agendamentos.findIndex(ag => ag.id === id);
                    agendamentos[index] = {...agendamentos[index], ...agendamento};
                } else { // Novo
                    agendamentos.push(agendamento);
                }

                saveAgendamentos();
                renderCalendario();
                agendamentoModal.classList.add('hidden');
            };

            const handleDeleteAgendamento = () => {
                const id = parseInt(agendamentoIdInput.value);
                if (id && confirm('Tem certeza que deseja excluir este agendamento?')) {
                    agendamentos = agendamentos.filter(ag => ag.id !== id);
                    saveAgendamentos();
                    renderCalendario();
                    agendamentoModal.classList.add('hidden');
                }
            };
            
            const handleLancarReceita = () => {
                const id = parseInt(agendamentoIdInput.value);
                const ag = agendamentos.find(a => a.id === id);
                if (!ag) return;

                const cliente = clientes.find(c => c.id === ag.clienteId);
                const clienteNome = cliente ? cliente.nome : 'Cliente';

                transactions.push({
                    id: Date.now(),
                    type: 'receita',
                    description: `Serviço: ${ag.servicoNome} (Cliente: ${clienteNome})`,
                    amount: ag.valorCobrado,
                    date: ag.data,
                    category: 'Agendamento',
                    agendamentoId: ag.id
                });
                
                ag.receitaLancada = true;
                const index = agendamentos.findIndex(a => a.id === id);
                agendamentos[index] = ag;

                saveTransactions();
                saveAgendamentos();
                updateUI();
                
                lancarReceitaBtn.disabled = true;
                lancarReceitaBtn.textContent = 'Receita Lançada';
                alert('Receita lançada com sucesso no financeiro!');
            };

            const handleLembreteWhatsApp = () => {
                const agendamentoId = parseInt(agendamentoIdInput.value);
                const agendamento = agendamentos.find(ag => ag.id === agendamentoId);
                if (!agendamento) return alert('Agendamento não encontrado.');

                const clienteId = agendamento.clienteId;
                const cliente = clientes.find(c => c.id === clienteId);
                if (!cliente || !cliente.contato) return alert('O cliente não tem um número de contato salvo. Adicione o número na aba "Clientes".');

                const numero = cliente.contato.replace(/\D/g, ''); // Remove caracteres não numéricos
                const nomeCliente = cliente.nome.split(' ')[0]; // Pega só o primeiro nome
                const dataAgendamento = formatDate(agendamento.data);
                const horaAgendamento = agendamento.horaInicio;

                const texto = `Olá, ${nomeCliente}! Passando para confirmar seu horário na Fiozart amanhã, dia ${dataAgendamento} às ${horaAgendamento}. Podemos confirmar?`;
                const linkWhatsApp = `https://wa.me/${numero}?text=${encodeURIComponent(texto)}`;

                window.open(linkWhatsApp, '_blank');
            };


            // --- ATUALIZAÇÃO DA UI GERAL ---
            const updateUI = () => {
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();

                const transactionsDoMes = transactions.filter(t => {
                    const dataT = new Date(t.date);
                    return dataT.getMonth() === mesAtual && dataT.getFullYear() === anoAtual;
                });

                transactionList.innerHTML = '';
                if (transactionsDoMes.length === 0) {
                    transactionList.innerHTML = '<p class="text-center text-gray-500">Nenhum lançamento este mês.</p>';
                } else {
                   [...transactionsDoMes].reverse().forEach(t => {
                        const div = document.createElement('div');
                        const amountClass = t.amount > 0 ? 'text-green-600' : 'text-red-600';
                        const sign = t.amount > 0 ? '+' : '';
                        div.className = 'flex justify-between items-center p-3 rounded-lg hover:bg-gray-50';
                        div.innerHTML = `
                            <div>
                                <p class="font-semibold">${t.description}</p>
                                <p class="text-sm text-gray-500">${formatDate(t.date)}</p>
                            </div>
                            <div class="flex items-center">
                                <span class="font-bold text-lg ${amountClass}">${sign} ${formatCurrency(t.amount)}</span>
                                <button onclick="window.deleteTransaction(${t.id})" class="ml-4 text-gray-400 hover:text-red-500 font-bold"> &times; </button>
                            </div>
                        `;
                        transactionList.appendChild(div);
                    });
                }
                
                const receitas = transactionsDoMes.filter(t => t.type === 'receita').reduce((acc, t) => acc + t.amount, 0);
                const despesas = transactionsDoMes.filter(t => t.type === 'despesa').reduce((acc, t) => acc + t.amount, 0);
                const lucro = receitas + despesas;

                receitaMesEl.textContent = formatCurrency(receitas);
                despesaMesEl.textContent = formatCurrency(Math.abs(despesas));
                lucroMesEl.textContent = formatCurrency(lucro);
                lucroMesEl.classList.toggle('text-red-600', lucro < 0);
                lucroMesEl.classList.toggle('text-brand-dark', lucro >= 0);

                popularCatalogoNoForm(servicoSelect);
                popularCatalogoNoForm(agendamentoServicoSelect);
                renderCatalogoList();
                renderMetas();
                renderCharts(transactionsDoMes);
            };

            const setTransactionType = (type) => {
                transactionType = type;
                if (type === 'receita') {
                    btnReceita.className = 'w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg';
                    btnDespesa.className = 'w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg';
                    servicoContainer.style.display = 'block';
                    categoriaDespesaContainer.classList.add('hidden');
                    handleServicoChange(); 
                } else {
                    btnDespesa.className = 'w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg';
                    btnReceita.className = 'w-full bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg';
                    servicoContainer.style.display = 'none';
                    descricaoContainer.classList.remove('hidden');
                    categoriaDespesaContainer.classList.remove('hidden');
                }
            };
            
            const handleServicoChange = () => {
                if (servicoSelect.value === 'outro') {
                    descricaoContainer.classList.remove('hidden');
                    valorInput.value = '';
                    valorInput.readOnly = false;
                } else if (servicoSelect.value) {
                    descricaoContainer.classList.add('hidden');
                    const selectedOption = servicoSelect.options[servicoSelect.selectedIndex];
                    valorInput.value = selectedOption.dataset.valor || '';
                    valorInput.readOnly = false; 
                } else {
                    descricaoContainer.classList.add('hidden');
                    valorInput.value = '';
                    valorInput.readOnly = false;
                }
            };
            
            const handleAgendamentoServicoChange = () => {
                const selectedOption = agendamentoServicoSelect.options[agendamentoServicoSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.valor) {
                    agendamentoValorInput.value = selectedOption.dataset.valor;
                } else {
                    agendamentoValorInput.value = '';
                }
            };


            // --- LÓGICA DE GRÁFICOS ---
            const renderCharts = (data) => {
                const labels = [...new Set(data.map(t => t.date))].sort();
                const receitaData = labels.map(label => 
                    data.filter(t => t.date === label && t.type === 'receita').reduce((sum, t) => sum + t.amount, 0)
                );
                const despesaData = labels.map(label => 
                    data.filter(t => t.date === label && t.type === 'despesa').reduce((sum, t) => sum + Math.abs(t.amount), 0)
                );

                if(fluxoCaixaChart) fluxoCaixaChart.destroy();
                fluxoCaixaChart = new Chart(document.getElementById('fluxoCaixaChart'), {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{ label: 'Receitas', data: receitaData, borderColor: 'rgb(22, 163, 74)', tension: 0.1 }, 
                                   { label: 'Despesas', data: despesaData, borderColor: 'rgb(220, 38, 38)', tension: 0.1 }]
                    }
                });

                const despesas = data.filter(t => t.type === 'despesa');
                const categorias = [...new Set(despesas.map(d => d.category))];
                const despesasPorCategoria = categorias.map(cat => 
                    despesas.filter(d => d.category === cat).reduce((sum, d) => sum + Math.abs(d.amount), 0)
                );
                if (despesasPorCategoria.length === 0) {
                    categorias.push("Nenhuma Despesa");
                    despesasPorCategoria.push(1);
                }

                if(despesasChart) despesasChart.destroy();
                despesasChart = new Chart(document.getElementById('despesasChart'), {
                    type: 'pie',
                    data: {
                        labels: categorias,
                        datasets: [{
                            data: despesasPorCategoria,
                            backgroundColor: ['#8d5b4c', '#d4a373', '#4a2c2a', '#a1a1aa', '#71717a', '#fdf8f0'],
                            hoverOffset: 4
                        }]
                    }
                });
            };

            // --- LÓGICA DE RELATÓRIOS ---
            const generateReport = () => {
                const startDate = new Date(reportStartDateInput.value + 'T00:00:00-03:00');
                const endDate = new Date(reportEndDateInput.value + 'T23:59:59-03:00');

                if(!reportStartDateInput.value || !reportEndDateInput.value) {
                    alert('Por favor, selecione as datas de início e fim.');
                    return;
                }
                
                reportPeriodEl.textContent = `Período: ${formatDate(reportStartDateInput.value)} a ${formatDate(reportEndDateInput.value)}`;

                const filteredTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate >= startDate && tDate <= endDate;
                });
                const filteredAgendamentos = agendamentos.filter(ag => {
                     const agDate = new Date(ag.data);
                    return agDate >= startDate && agDate <= endDate && ag.status === 'Realizado';
                });

                // 1. KPIs
                const totalReceita = filteredTransactions.filter(t => t.type === 'receita').reduce((sum, t) => sum + t.amount, 0);
                const totalDespesa = Math.abs(filteredTransactions.filter(t => t.type === 'despesa').reduce((sum, t) => sum + t.amount, 0));
                reportTotalReceitaEl.textContent = formatCurrency(totalReceita);
                reportTotalDespesaEl.textContent = formatCurrency(totalDespesa);
                reportTotalLucroEl.textContent = formatCurrency(totalReceita - totalDespesa);

                // 2. Gráfico Faturamento Mensal
                const monthlyData = {};
                filteredTransactions.forEach(t => {
                    const month = t.date.substring(0, 7); // YYYY-MM
                    if(!monthlyData[month]) monthlyData[month] = {receita: 0, despesa: 0};
                    if(t.type === 'receita') monthlyData[month].receita += t.amount;
                    else monthlyData[month].despesa += Math.abs(t.amount);
                });

                const sortedMonths = Object.keys(monthlyData).sort();
                const faturamentoLabels = sortedMonths.map(m => new Date(m + '-02').toLocaleDateString('pt-BR', {month:'short', year:'2-digit'}));
                const faturamentoReceitas = sortedMonths.map(m => monthlyData[m].receita);
                const faturamentoDespesas = sortedMonths.map(m => monthlyData[m].despesa);
                
                if(reportFaturamentoChart) reportFaturamentoChart.destroy();
                reportFaturamentoChart = new Chart(document.getElementById('reportFaturamentoChart'), {
                    type: 'bar',
                    data: {
                        labels: faturamentoLabels,
                        datasets: [
                            {label: 'Receita', data: faturamentoReceitas, backgroundColor: 'rgb(34, 197, 94)'},
                            {label: 'Despesa', data: faturamentoDespesas, backgroundColor: 'rgb(239, 68, 68)'}
                        ]
                    }
                });

                // 3. Ranking de Serviços
                const servicosRank = filteredAgendamentos.reduce((acc, ag) => {
                    if(!acc[ag.servicoNome]) acc[ag.servicoNome] = { count: 0, total: 0 };
                    acc[ag.servicoNome].count++;
                    acc[ag.servicoNome].total += ag.valorCobrado;
                    return acc;
                }, {});

                const sortedServicos = Object.entries(servicosRank).sort((a,b) => b[1].total - a[1].total);
                reportServicosListEl.innerHTML = sortedServicos.map(([nome, data]) => `
                    <div class="flex justify-between items-center border-b pb-2">
                        <p>${nome}</p>
                        <div class="text-right">
                           <p class="font-bold">${formatCurrency(data.total)}</p>
                           <p class="text-sm text-gray-500">${data.count} vez(es)</p>
                        </div>
                    </div>
                `).join('');


                // 4. Ranking de Clientes
                const clientesRank = filteredAgendamentos.reduce((acc, ag) => {
                    if(!acc[ag.clienteId]) acc[ag.clienteId] = { count: 0, total: 0 };
                    acc[ag.clienteId].count++;
                    acc[ag.clienteId].total += ag.valorCobrado;
                    return acc;
                }, {});

                const sortedClientes = Object.entries(clientesRank).sort((a,b) => b[1].total - a[1].total);
                reportClientesListEl.innerHTML = sortedClientes.map(([clienteId, data]) => {
                    const cliente = clientes.find(c => c.id === parseInt(clienteId));
                    return `
                    <div class="flex justify-between items-center border-b pb-2">
                        <p>${cliente ? cliente.nome : 'Cliente Apagado'}</p>
                        <div class="text-right">
                           <p class="font-bold">${formatCurrency(data.total)}</p>
                           <p class="text-sm text-gray-500">${data.count} agendamento(s)</p>
                        </div>
                    </div>
                `}).join('');

                // 5. Gráfico Despesas
                const reportDespesas = filteredTransactions.filter(t => t.type === 'despesa');
                const reportCategorias = [...new Set(reportDespesas.map(d => d.category))];
                const reportDespesasPorCategoria = reportCategorias.map(cat => 
                    reportDespesas.filter(d => d.category === cat).reduce((sum, d) => sum + Math.abs(d.amount), 0)
                );
                 if (reportDespesasPorCategoria.length === 0) {
                    reportCategorias.push("Nenhuma Despesa");
                    reportDespesasPorCategoria.push(1);
                }

                if(reportDespesasChart) reportDespesasChart.destroy();
                reportDespesasChart = new Chart(document.getElementById('reportDespesasChart'), {
                    type: 'pie',
                    data: {
                        labels: reportCategorias,
                        datasets: [{
                            data: reportDespesasPorCategoria,
                            backgroundColor: ['#8d5b4c', '#d4a373', '#4a2c2a', '#a1a1aa', '#71717a', '#fdf8f0'],
                        }]
                    },
                    options: { plugins: { legend: { position: 'bottom' } } }
                });
            };

            // --- LÓGICA DE BACKUP/RESTORE ---
            const handleBackup = () => {
                const allData = {
                    transactions, catalogoServicos, agendamentos, metas, clientes
                };

                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                const date = new Date().toISOString().slice(0, 10);
                link.href = url;
                link.download = `backup_fiozart_${date}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };
            
            const handleRestore = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        const requiredKeys = ['transactions', 'catalogoServicos', 'agendamentos', 'metas', 'clientes'];
                        const hasAllKeys = requiredKeys.every(key => key in importedData);
                        
                        if (hasAllKeys) {
                           if(confirm('Tem certeza que deseja restaurar os dados? Todos os dados atuais serão substituídos por este backup. Esta ação não pode ser desfeita.')) {
                                localStorage.setItem('fiozart_transactions', JSON.stringify(importedData.transactions || []));
                                localStorage.setItem('fiozart_catalogo', JSON.stringify(importedData.catalogoServicos || []));
                                localStorage.setItem('fiozart_agendamentos', JSON.stringify(importedData.agendamentos || []));
                                localStorage.setItem('fiozart_metas', JSON.stringify(importedData.metas || []));
                                localStorage.setItem('fiozart_clientes', JSON.stringify(importedData.clientes || []));
                                
                                alert('Backup restaurado com sucesso! A página será recarregada.');
                                location.reload();
                           }
                        } else {
                            throw new Error('Formato de arquivo inválido.');
                        }
                    } catch (error) {
                        console.error('Erro ao restaurar o arquivo:', error);
                        alert('Erro ao restaurar o backup. O arquivo pode estar corrompido ou em um formato inválido.');
                    } finally {
                        restoreFileInput.value = '';
                    }
                };
                reader.readAsText(file);
            };
            
            // --- INICIALIZAÇÃO E EVENT LISTENERS ---
            const init = () => {
                window.deleteTransaction = deleteTransaction;

                // Listeners de Navegação
                toggleToFinanceiroBtn.addEventListener('click', () => switchView(financeiroView));
                toggleToAgendaBtn.addEventListener('click', () => switchView(agendaView));
                toggleToClientesBtn.addEventListener('click', () => switchView(clientesView));
                toggleToRelatoriosBtn.addEventListener('click', () => switchView(relatoriosView));

                // Listeners financeiros
                transactionForm.addEventListener('submit', addTransaction);
                btnReceita.addEventListener('click', () => setTransactionType('receita'));
                btnDespesa.addEventListener('click', () => setTransactionType('despesa'));
                servicoSelect.addEventListener('change', handleServicoChange);
                dataInput.value = new Date().toISOString().split('T')[0];
                
                // Listeners do Catálogo
                openCatalogBtn.addEventListener('click', () => catalogModal.classList.remove('hidden'));
                closeCatalogBtn.addEventListener('click', () => catalogModal.classList.add('hidden'));
                catalogForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const nome = servicoNomeInput.value.trim();
                    const valor = parseValue(servicoValorInput.value);
                    const id = parseInt(catalogForm.dataset.editingId);

                    if (!nome || !valor) return;

                    if (id) {
                        const index = catalogoServicos.findIndex(s => s.id === id);
                        catalogoServicos[index] = { id, nome, valor };
                        delete catalogForm.dataset.editingId;
                    } else { 
                        catalogoServicos.push({ id: Date.now(), nome, valor });
                    }
                    saveCatalogo();
                    updateUI();
                    catalogForm.reset();
                });

                catalogList.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    if (e.target.matches('.delete-servico-btn')) {
                        if (confirm('Tem certeza?')) {
                            catalogoServicos = catalogoServicos.filter(s => s.id !== id);
                            saveCatalogo();
                            updateUI();
                        }
                    } else if (e.target.matches('.edit-servico-btn')) {
                        const servico = catalogoServicos.find(s => s.id === id);
                        servicoNomeInput.value = servico.nome;
                        servicoValorInput.value = servico.valor;
                        catalogForm.dataset.editingId = id;
                    }
                });

                // Listeners de Metas
                metaForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    metas.push({
                        id: Date.now(),
                        nome: metaNomeInput.value.trim(),
                        valorTotal: parseValue(metaValorTotalInput.value),
                        valorGuardado: 0,
                    });
                    saveMetas();
                    renderMetas();
                    metaForm.reset();
                });

                metaList.addEventListener('click', (e) => {
                    const id = parseInt(e.target.dataset.id);
                    if (e.target.matches('.delete-meta-btn')) {
                        if(confirm('Tem certeza?')) {
                            metas = metas.filter(m => m.id !== id);
                            saveMetas();
                            renderMetas();
                        }
                    } else if (e.target.matches('.add-valor-btn')) {
                        const valorAdicional = parseValue(prompt('Quanto você deseja adicionar a esta meta?'));
                        if(valorAdicional > 0) {
                            const index = metas.findIndex(m => m.id === id);
                            metas[index].valorGuardado += valorAdicional;
                            saveMetas();
                            renderMetas();
                        }
                    }
                });

                // Listeners de Clientes
                addClienteBtn.addEventListener('click', () => openClienteModal());
                closeClienteModalBtn.addEventListener('click', () => clienteModal.classList.add('hidden'));
                editClienteBtn.addEventListener('click', (e) => openClienteModal(parseInt(e.target.dataset.id)));
                clienteForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const id = parseInt(clienteIdInput.value);
                    const clienteData = {
                        nome: clienteNomeInput.value.trim(),
                        contato: clienteContatoInput.value.trim(),
                        instagram: clienteInstagramInput.value.trim(),
                        notas: clienteNotasInput.value.trim(),
                    };
                    if(!clienteData.nome) return alert('O nome do cliente é obrigatório.');

                    if(id) {
                        const index = clientes.findIndex(c => c.id === id);
                        clientes[index] = {...clientes[index], ...clienteData};
                    } else {
                        clientes.push({id: Date.now(), ...clienteData});
                    }
                    saveClientes();
                    renderClientList();
                    if(id) renderClientDetails(id);
                    clienteModal.classList.add('hidden');
                });

                deleteClienteBtn.addEventListener('click', () => {
                    const id = parseInt(clienteIdInput.value);
                    if(confirm('Tem certeza que deseja excluir este cliente? Todo o seu histórico será mantido, mas o nome não será mais exibido nos agendamentos.')) {
                        clientes = clientes.filter(c => c.id !== id);
                        saveClientes();
                        selectedClientId = null;
                        renderClientList();
                        renderClientDetails(null);
                        clienteModal.classList.add('hidden');
                    }
                });


                // Listeners da Agenda
                closeAgendamentoBtn.addEventListener('click', () => agendamentoModal.classList.add('hidden'));
                agendamentoForm.addEventListener('submit', handleSaveAgendamento);
                deleteAgendamentoBtn.addEventListener('click', handleDeleteAgendamento);
                lancarReceitaBtn.addEventListener('click', handleLancarReceita);
                lembreteWppBtn.addEventListener('click', handleLembreteWhatsApp);
                agendamentoServicoSelect.addEventListener('change', handleAgendamentoServicoChange);

                // Listeners de Relatórios
                generateReportBtn.addEventListener('click', generateReport);
                printReportBtn.addEventListener('click', () => window.print());

                // Listeners de Backup/Restore
                backupBtn.addEventListener('click', handleBackup);
                restoreBtn.addEventListener('click', () => restoreFileInput.click());
                restoreFileInput.addEventListener('change', handleRestore);

                // Estado Inicial
                switchView(financeiroView);
                setTransactionType('receita');
                updateUI();
            };

            init();
        });
    </script>
</body>
</html>
